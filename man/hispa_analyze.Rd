% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/hispa_functions.R
\name{hispa_analyze}
\alias{hispa_analyze}
\title{Run HiSpa MCMC Analysis}
\usage{
hispa_analyze(
  hic_experiment,
  output_dir,
  mcmc_iterations = 6000L,
  num_clusters = 0L,
  mcmc_burn_in = 0L,
  mcmc_initial_sd = 0.1,
  mcmc_sd_floor = 1e-04,
  mcmc_sd_ceil = 0.3,
  use_cluster_init = FALSE,
  cluster_init_iterations = 1000L,
  cluster_initial_sd = 0.1,
  save_samples = FALSE,
  sample_interval = 50L,
  verbose = TRUE,
  filter_quantile = -1,
  safe_mode = TRUE
)
}
\arguments{
\item{hic_experiment}{A Bioconductor `HiCExperiment` object or a numeric matrix
containing Hi-C contact data. If a `HiCExperiment` object, the function extracts 
the contact matrix using `gi2cm()` from the interactions and converts it to a 
numeric matrix for analysis. If a matrix, it is used directly.}

\item{output_dir}{Character string specifying the output directory path.}

\item{mcmc_iterations}{Integer, number of MCMC iterations (default: 6000).}

\item{num_clusters}{Integer, number of clusters for hierarchical analysis. 
If 0 (default), automatically determined as sqrt(n).}

\item{mcmc_burn_in}{Integer, number of burn-in iterations to discard (default: 0).}

\item{mcmc_initial_sd}{Numeric, initial standard deviation for MCMC proposals (default: 0.1).}

\item{mcmc_sd_floor}{Numeric, minimum allowed standard deviation (default: 0.0001).}

\item{mcmc_sd_ceil}{Numeric, maximum allowed standard deviation (default: 0.3).}

\item{use_cluster_init}{Logical, use cluster-based initialization instead of 
random initialization (default: FALSE).}

\item{cluster_init_iterations}{Integer, number of iterations for cluster 
initialization MCMC (default: 1000).}

\item{cluster_initial_sd}{Numeric, initial standard deviation for cluster 
initialization MCMC (default: 0.1).}

\item{save_samples}{Logical, whether to save MCMC trace samples (default: FALSE).}

\item{sample_interval}{Integer, save samples every n iterations (default: 50).}

\item{verbose}{Logical, enable verbose output (default: TRUE).}

\item{filter_quantile}{Numeric, quantile threshold for filtering loci by contact counts 
(default: -1, no filtering). If >= 0, loci with row sums below this quantile are removed. 
For example, 0.1 removes loci in the bottom 10\% of contact counts.}

\item{safe_mode}{Logical, whether to run analysis in a safe subprocess using callr 
(default: TRUE). If TRUE and callr is available, analysis runs in an isolated subprocess 
to prevent R crashes from affecting the parent session. Set to FALSE to run inline.}
}
\value{
A list containing:
  \itemize{
    \item \strong{positions} - A numeric matrix of dimensions n x 3 containing the 
      final inferred 3D coordinates of loci. Rows correspond to loci, columns are (x, y, z).
    \item \strong{beta0} - The final intercept parameter of the log-distance relationship.
    \item \strong{beta1} - The final slope parameter of the log-distance relationship.
  }
  If filtering was applied, the positions matrix has an attribute `filtered_locus_indices` 
  containing the original indices of the retained loci (before filtering).
  Additionally, all analysis results are saved as text files in the output directory.
}
\description{
Performs hierarchical Bayesian inference of 3D chromatin structure from
Hi-C contact matrix using MCMC sampling. This function follows the exact
workflow from the HiSpa C++ implementation.
}
\details{
This function implements the complete HiSpa workflow:
\enumerate{
  \item Filter loci by contact count (optional)
  \item Load contact matrix from file
  \item Assign loci to clusters (k-means)
  \item Build cluster relationships
  \item Initialize structure (random or cluster-based)
  \item Assemble global structure
  \item Run main MCMC algorithm
  \item Save results to output directory
}

\bold{Locus Filtering:} By default, no filtering is applied (filter_quantile = -1). 
If filter_quantile >= 0, loci with contact counts below the specified quantile 
are removed before analysis. For example, filter_quantile = 0.1 removes loci in 
the bottom 10\% of contact counts. This improves computational efficiency and 
focuses analysis on loci with sufficient data.

All results are automatically saved to the output directory:
\itemize{
  \item \strong{final_positions.txt} - Final inferred 3D coordinates (n x 3 matrix)
  \item \strong{initial_positions.txt} - Initial positions before MCMC (n x 3 matrix)
}

Read results using standard R functions:
\code{final_pos <- read.table("output_dir/final_positions.txt")}
}
\examples{
# Load example contact matrix
data(su1_contact_mat)

# Check dimensions
dim(su1_contact_mat)

\donttest{
# Example 1: Run analysis with matrix input
su_res <- hispa_analyze(
  hic_experiment = su1_contact_mat,
  output_dir = tempdir(),
  mcmc_iterations = 100,
  mcmc_burn_in = 10,
  use_cluster_init = FALSE,
  verbose = TRUE
)

# check results
dim(su_res$positions)  # Should be n x 3
}

}
